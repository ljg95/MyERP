version: '3.8'

services:
  # --- Databases ---
  product-db:
    image: postgres:15-alpine
    container_name: product-db
    environment:
      POSTGRES_USER: myerp
      POSTGRES_PASSWORD: password
      POSTGRES_DB: product_db
    ports:
      - "5432:5432"
    volumes:
      - product_db_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U myerp -d product_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

  partner-db:
    image: postgres:15-alpine
    container_name: partner-db
    environment:
      POSTGRES_USER: myerp
      POSTGRES_PASSWORD: password
      POSTGRES_DB: partner_db
    ports:
      - "5433:5432"
    volumes:
      - partner_db_data:/var/lib/postgresql/data

  # --- Microservices ---
  discovery-service:
    build: ./backend/discovery-service
    container_name: discovery-service # 컨테이너 이름 (도커 네트워크 내에서 도메인 이름처럼 사용됨)
    ports:
      - "8761:8761" # 웹 브라우저 접속용 포트 매핑 (호스트:컨테이너)
    environment:
      # 자기가 자기 자신을 가리키는 호스트 이름 설정
      - EUREKA_INSTANCE_HOSTNAME=discovery-service

  gateway-service:
    build: ./backend/gateway-service
    container_name: gateway-service
    ports:
      - "8080:8080" # 사용자가 진입하는 최종 포트 (이 포트로만 API 호출)
    environment:
      # [핵심] Eureka 서버에게 "길을 물어보기" 위해 Eureka의 주소를 명시함.
      # 여기서 'discovery-service'는 위의 컨테이너 이름과 동일하며, 도커 내부망에서 IP 변환됨.
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      - discovery-service # Eureka가 먼저 켜진 후에 Gateway가 켜지도록 순서 강제

  product-service:
    build: ./backend/product-service
    container_name: product-service
    ports:
      - "8081:8081" # 테스트용 직접 접근 포트 (실제로는 Gateway를 통해 접근)
    environment:
      # [핵심] Eureka 서버에게 "나(Product) 태어났어"라고 출생신고 및 주소 등록을 함.
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      # [DB 연결] 'product-db'라는 컨테이너 이름을 도메인처럼 사용하여 위에서 띄운 DB에 연결
      - SPRING_DATASOURCE_URL=jdbc:postgresql://product-db:5432/product_db
    depends_on:
      product-db:
        condition: service_healthy
      discovery-service:
        condition: service_started

volumes:
  product_db_data:
  partner_db_data:
